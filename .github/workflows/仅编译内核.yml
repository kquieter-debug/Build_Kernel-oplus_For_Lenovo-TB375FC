name: Android Kernel Build (Cache Optimized)
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: æ£€å‡ºå†…æ ¸æºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive # å¦‚æœä½ çš„å†…æ ¸æœ‰å­æ¨¡å—ï¼Œå¿…é¡»å¼€å¯

      # ===================== ã€æ ¸å¿ƒç¼“å­˜1ï¼šAptä¾èµ–ç¼“å­˜ - ç³»ç»Ÿç¼–è¯‘ä¾èµ–ã€‘ =====================
      - name: ç¼“å­˜ Ubuntu Apt ä¾èµ–åŒ…
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: gcc g++ make perl python3 bc bison flex libssl-dev libelf-dev dwarves git curl wget zip unzip build-essential ccache bazel
          version: 1.0
          refresh: false

      # ===================== ã€æ ¸å¿ƒç¼“å­˜2ï¼šCcache ç¼–è¯‘ç¼“å­˜ - æé€Ÿ90%çš„æ ¸å¿ƒã€‘ =====================
      - name: é…ç½® Ccache ç¯å¢ƒ & ç¼“å­˜ç¼–è¯‘ä¸­é—´äº§ç‰©
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-kernel-ccache-${{ github.sha }}
          restore-keys: ${{ runner.os }}-kernel-ccache-
          max-size: 10G # ccacheç¼“å­˜æœ€å¤§10Gï¼Œè¶³å¤Ÿå­˜æ”¾æ‰€æœ‰å†…æ ¸ç¼–è¯‘äº§ç‰©ï¼ŒæŒ‰éœ€è°ƒæ•´

      # ===================== ã€æ ¸å¿ƒç¼“å­˜3ï¼šå†…æ ¸ç¼–è¯‘äº§ç‰©/é…ç½®ç¼“å­˜ - outç›®å½• + .configã€‘ =====================
      - name: ç¼“å­˜ å†…æ ¸outç¼–è¯‘ç›®å½• + .configé…ç½®æ–‡ä»¶
        uses: actions/cache@v4
        id: kernel-build-cache
        with:
          path: |
            out
            .config
            arch/arm64/configs # ä½ çš„å†…æ ¸defconfigç›®å½•ï¼ŒæŒ‰éœ€ä¿ç•™
            arch/x86/configs
          # ç¼“å­˜KEYè§„åˆ™ï¼šç²¾å‡†å‘½ä¸­ï¼Œé¿å…ç¼“å­˜æ±¡æŸ“ï¼Œå®Œç¾é€‚é…å†…æ ¸ç¼–è¯‘
          key: ${{ runner.os }}-kernel-build-${{ hashFiles('.config', 'Makefile') }}-${{ github.sha }}
          # é™çº§å‘½ä¸­è§„åˆ™ï¼šå¦‚æœç²¾å‡†KEYå¤±æ•ˆï¼Œå‘½ä¸­åŒç³»ç»Ÿçš„é€šç”¨ç¼“å­˜ï¼Œä¿è¯ç¼“å­˜å‘½ä¸­ç‡
          restore-keys: |
            ${{ runner.os }}-kernel-build-${{ hashFiles('.config', 'Makefile') }}-
            ${{ runner.os }}-kernel-build-

      # ===================== ã€æ ¸å¿ƒç¼“å­˜4ï¼šäº¤å‰ç¼–è¯‘å·¥å…·é“¾/NDKç¼“å­˜ - é¿å…é‡å¤ä¸‹è½½ã€‘ =====================
      - name: ç¼“å­˜ å®‰å“äº¤å‰ç¼–è¯‘é“¾/NDK å·¥å…·é“¾
        uses: actions/cache@v4
        id: toolchain-cache
        with:
          path: |
            toolchain
            prebuilts
            ndk
            clang
          key: ${{ runner.os }}-kernel-toolchain-${{ hashFiles('**/toolchain.version') }}
          restore-keys: |
            ${{ runner.os }}-kernel-toolchain-

      # ===================== ã€å¿…åšï¼šå¯ç”¨CCACHEç¼–è¯‘åŠ é€Ÿï¼Œé…ç½®å†…æ ¸ç¼–è¯‘å‚æ•°ã€‘ =====================
      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ & å¯ç”¨CCACHEï¼ˆå…³é”®ï¼è®©å†…æ ¸ç¼–è¯‘èµ°ç¼“å­˜ï¼‰
        run: |
          echo -e "ğŸ¤“å¯ç”¨CCACHEå†…æ ¸ç¼–è¯‘ç¼“å­˜"
          export CCACHE_EXEC=$(which ccache)
          export USE_CCACHE=1
          export CCACHE_DIR=${{ github.workspace }}/.ccache
          # é…ç½®ccacheæœ€ä¼˜å‚æ•°ï¼šå‹ç¼©ç¼“å­˜ã€æœ€å¤§åŒ–å‘½ä¸­ç‡ã€å…¼å®¹å†…æ ¸ç¼–è¯‘
          ccache -M 10G
          ccache -z
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o cache_dir=${{ github.workspace }}/.ccache
          # æ‰“å°ccacheçŠ¶æ€ï¼Œæ–¹ä¾¿è°ƒè¯•
          ccache -s
          # ç»™ç¼–è¯‘ç›®å½•èµ‹æƒï¼Œé¿å…ç¼“å­˜è¯»å†™æƒé™é—®é¢˜
          chmod -R 777 out/ || true
          chmod -R 777 toolchain/ || true
          echo "ğŸ¤“ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼Œç¼“å­˜å·²å¯ç”¨"

      # ===================== ã€ä½ çš„åŸæœ‰ç¼–è¯‘æ­¥éª¤ï¼Œç›´æ¥ç²˜è´´åœ¨è¿™é‡Œå³å¯ã€‘ =====================
      - name: å¼€å§‹ç¼–è¯‘å®‰å“å†…æ ¸ï¼ˆå¸¦ç¼“å­˜åŠ é€Ÿï¼‰
        run: |
          # ä½ çš„åŸæœ‰ç¼–è¯‘æ­¥éª¤ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼ŒæŒ‰éœ€æ›¿æ¢ä¸ºä½ è‡ªå·±çš„
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CC=ccache clang # æ ¸å¿ƒï¼šç”¨ccacheåŒ…è£¹ç¼–è¯‘å™¨ï¼Œè®©ç¼–è¯‘äº§ç‰©è¿›å…¥ç¼“å­˜
          export CXX=ccache clang++
          # å†…æ ¸é…ç½®
          make -j$(nproc) O=out your_defconfig
          # å†…æ ¸ç¼–è¯‘ -j$(nproc) è‡ªåŠ¨å¤šæ ¸ç¼–è¯‘ï¼Œé…åˆç¼“å­˜é€Ÿåº¦æ‹‰æ»¡
          make -j$(nproc) O=out Image.gz-dtb modules dtbs 2>&1 | tee build.log
          
      # ===================== ã€ç¼–è¯‘å®Œæˆåæ›´æ–°CCACHEç¼“å­˜ç»Ÿè®¡ã€‘ =====================
      - name: æ›´æ–°ç¼“å­˜ç»Ÿè®¡ & æ¸…ç†æ— ç”¨ç¼“å­˜
        run: |
          ccache -s
          ccache -c # æ¸…ç†è¿‡æœŸç¼“å­˜ï¼Œé‡Šæ”¾ç©ºé—´
          echo "ğŸ¤“æœ¬æ¬¡ç¼–è¯‘ç¼“å­˜å‘½ä¸­ç‡ï¼š$(ccache -s | grep 'hit rate' | awk '{print $4}')ğŸ¤“"

      # ===================== ã€ä½ çš„åŸæœ‰äº§ç‰©ä¸Šä¼ æ­¥éª¤ï¼Œä¸å˜ã€‘ =====================
      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Build-Output
          path: out/arch/arm64/boot/